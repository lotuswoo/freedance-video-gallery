<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宗教動態貼圖館 - GitHub整合後台</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #d1d5db;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #f59e0b;
            background-color: #fef3c7;
        }
        .upload-area.dragover {
            border-color: #f59e0b;
            background-color: #fef3c7;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }
        .modal-content {
            background: white;
            border-radius: 12px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            animation: slideIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes slideIn {
            from { transform: translateY(-20px) scale(0.95); opacity: 0; }
            to { transform: translateY(0) scale(1); opacity: 1; }
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 2000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }
        .toast.show {
            transform: translateX(0);
        }
        .toast.success { background-color: #10b981; }
        .toast.error { background-color: #ef4444; }
        .toast.warning { background-color: #f59e0b; }
        .work-card {
            transition: all 0.3s ease;
        }
        .work-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
        }
        .work-card.selected {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .search-highlight {
            background-color: #fef3c7;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .format-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .format-gif {
            background-color: #fef3c7;
            color: #92400e;
        }
        .format-webp {
            background-color: #dbeafe;
            color: #1e40af;
        }
        .ai-tag-suggestion {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin: 2px;
        }
        .ai-tag-suggestion:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .ai-processing {
            background: linear-gradient(45deg, #667eea, #764ba2);
            background-size: 200% 200%;
            animation: gradientShift 2s ease infinite;
        }
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        .dual-format-preview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin: 16px 0;
        }
        .format-preview {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }
        .format-preview.active {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }
        .github-status {
            display: inline-flex;
            align-items: center;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .github-connected {
            background-color: #dcfce7;
            color: #166534;
        }
        .github-disconnected {
            background-color: #fee2e2;
            color: #991b1b;
        }
        .sync-animation {
            animation: spin 1s linear infinite;
        }
        .github-config {
            background: linear-gradient(135deg, #24292e 0%, #586069 100%);
            color: white;
            border-radius: 8px;
            padding: 16px;
        }
        .deploy-status {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
        }
        .deploy-success {
            background-color: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }
        .deploy-pending {
            background-color: #fef3c7;
            color: #92400e;
            border: 1px solid #fde68a;
        }
        .deploy-error {
            background-color: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-amber-50 to-orange-50 min-h-screen">
    <!-- 頂部導航 -->
    <nav class="bg-white shadow-sm border-b border-amber-200 sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-gradient-to-br from-amber-400 to-orange-500 rounded-full flex items-center justify-center text-white text-lg font-bold">
                        🙏
                    </div>
                    <div>
                        <h1 class="text-xl font-bold bg-gradient-to-r from-amber-600 to-orange-600 bg-clip-text text-transparent">
                            宗教動態貼圖館
                        </h1>
                        <p class="text-sm text-amber-600">GitHub整合後台 <span class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-full ml-2">雲端同步</span></p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-sm text-gray-500">
                        <span>總作品: <span id="totalCount" class="font-semibold text-amber-600">0</span></span>
                        <span class="mx-2">|</span>
                        <span>雙格式: <span id="dualFormatCount" class="font-semibold text-blue-600">0</span></span>
                        <span class="mx-2">|</span>
                        <span id="githubStatus" class="github-status github-disconnected">
                            <i class="fab fa-github mr-1"></i>
                            未連接
                        </span>
                    </div>
                    <a href="/" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-lg hover:from-purple-600 hover:to-pink-600 transition-colors text-sm">
                        <i class="fas fa-home mr-2"></i>
                        返回主網站
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-4 py-8">
        <!-- 快速操作面板 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="flex flex-wrap items-center justify-between gap-4">
                <div class="flex items-center space-x-4">
                    <button onclick="showUploadModal()" class="inline-flex items-center px-4 py-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white rounded-lg hover:from-amber-600 hover:to-orange-600 transition-colors">
                        <i class="fab fa-github mr-2"></i>
                        上傳到GitHub
                    </button>
                    <button onclick="toggleBatchMode()" id="batchModeBtn" class="inline-flex items-center px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-check-square mr-2"></i>
                        批量操作
                    </button>
                    <div id="batchActions" class="hidden flex items-center space-x-2">
                        <button onclick="batchDownload()" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 transition-colors text-sm">
                            <i class="fas fa-download mr-1"></i>
                            批量下載
                        </button>
                        <button onclick="batchOptimize()" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition-colors text-sm">
                            <i class="fas fa-magic mr-1"></i>
                            批量優化
                        </button>
                        <button onclick="batchDelete()" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition-colors text-sm">
                            <i class="fas fa-trash mr-1"></i>
                            批量刪除
                        </button>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <button onclick="showGitHubConfigModal()" class="inline-flex items-center px-3 py-2 bg-gray-800 text-white rounded-lg hover:bg-gray-900 transition-colors text-sm">
                        <i class="fab fa-github mr-2"></i>
                        GitHub設置
                    </button>
                    <button onclick="exportData()" class="inline-flex items-center px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                        <i class="fas fa-download mr-2"></i>
                        匯出數據
                    </button>
                    <button onclick="importData()" class="inline-flex items-center px-3 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors text-sm">
                        <i class="fas fa-upload mr-2"></i>
                        匯入數據
                    </button>
                </div>
            </div>
        </div>

        <!-- 搜索和篩選 -->
        <div class="bg-white rounded-lg shadow-sm p-6 mb-8">
            <div class="grid md:grid-cols-5 gap-4">
                <div class="md:col-span-2">
                    <div class="relative">
                        <input type="text" id="searchInput" placeholder="搜索作品標題、描述或標籤..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                    </div>
                </div>
                <div>
                    <select id="categoryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="">所有分類</option>
                        <option value="mantra">咒語系列</option>
                        <option value="buddha">佛號系列</option>
                    </select>
                </div>
                <div>
                    <select id="formatFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="">所有格式</option>
                        <option value="dual">雙格式</option>
                        <option value="gif-only">僅GIF</option>
                    </select>
                </div>
                <div>
                    <select id="sortBy" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                        <option value="newest">最新上傳</option>
                        <option value="oldest">最早上傳</option>
                        <option value="title">標題排序</option>
                        <option value="size">檔案大小</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- 作品列表 -->
        <div class="bg-white rounded-lg shadow-sm p-6">
            <div class="flex items-center justify-between mb-6">
                <h3 class="text-xl font-semibold text-gray-800">智能作品管理</h3>
                <div class="flex items-center space-x-4">
                    <span class="text-sm text-gray-500">顯示 <span id="displayCount">0</span> 個作品</span>
                    <div class="flex items-center space-x-2">
                        <button onclick="changeView('grid')" id="gridViewBtn" class="p-2 text-gray-500 hover:text-amber-600 transition-colors">
                            <i class="fas fa-th-large"></i>
                        </button>
                        <button onclick="changeView('list')" id="listViewBtn" class="p-2 text-amber-600 hover:text-amber-700 transition-colors">
                            <i class="fas fa-list"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div id="worksContainer" class="space-y-4">
                <!-- 作品列表將在這裡動態生成 -->
            </div>

            <!-- 分頁 -->
            <div id="pagination" class="flex items-center justify-center space-x-2 mt-8 hidden">
                <button onclick="changePage('prev')" id="prevBtn" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div id="pageNumbers" class="flex space-x-1"></div>
                <button onclick="changePage('next')" id="nextBtn" class="px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- 上傳模態窗口 -->
    <div id="uploadModal" class="modal">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fab fa-github mr-2 text-gray-800"></i>
                    上傳到GitHub
                </h3>
                <button onclick="closeUploadModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- GitHub連接狀態 -->
            <div id="githubConnectionStatus" class="mb-6">
                <div class="github-config">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold flex items-center">
                            <i class="fab fa-github mr-2"></i>
                            GitHub連接狀態
                        </h4>
                        <span id="connectionStatus" class="github-status github-disconnected">
                            <i class="fas fa-times-circle mr-1"></i>
                            未連接
                        </span>
                    </div>
                    <div id="connectionMessage" class="text-sm text-gray-300">
                        請先在GitHub設置中配置您的Repository和Access Token
                    </div>
                </div>
            </div>

            <form id="uploadForm" class="space-y-6">
                <!-- 文件上傳區域 -->
                <div id="uploadArea" class="upload-area rounded-lg p-8 text-center">
                    <div class="text-6xl text-amber-500 mb-4">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <p class="text-lg text-gray-600 mb-2">點擊選擇GIF文件或拖拽到此處</p>
                    <p class="text-sm text-gray-500">支援透明背景的GIF格式，將自動生成WebP版本</p>
                    <input type="file" id="fileInput" accept=".gif" class="hidden">
                </div>

                <!-- 雙格式預覽 -->
                <div id="formatPreview" class="hidden">
                    <h4 class="text-sm font-medium text-gray-700 mb-3">
                        <i class="fas fa-eye mr-1"></i>
                        格式預覽
                    </h4>
                    <div class="dual-format-preview">
                        <div class="format-preview">
                            <div class="format-badge format-gif mb-2">GIF 原檔</div>
                            <img id="gifPreview" class="w-full h-32 object-cover rounded mb-2">
                            <p class="text-xs text-gray-500">保留透明效果，用於下載</p>
                        </div>
                        <div class="format-preview">
                            <div class="format-badge format-webp mb-2">WebP 展示</div>
                            <img id="webpPreview" class="w-full h-32 object-cover rounded mb-2">
                            <p class="text-xs text-gray-500">加速載入，網頁展示</p>
                        </div>
                    </div>
                </div>

                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag mr-1"></i>
                            作品標題 *
                        </label>
                        <input type="text" id="title" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="例：觀音心咒">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-heading mr-1"></i>
                            副標題
                        </label>
                        <input type="text" id="subtitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="例：慈悲觀音心咒 - 六字大明咒">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-align-left mr-1"></i>
                        作品描述
                    </label>
                    <textarea id="description" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="描述這個作品的特色和用途..."></textarea>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-folder mr-1"></i>
                            分類
                        </label>
                        <select id="category" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="mantra">咒語系列</option>
                            <option value="buddha">佛號系列</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-robot mr-1 text-purple-600"></i>
                            AI智能標籤
                        </label>
                        <div class="relative">
                            <input type="text" id="tags" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500" placeholder="AI正在分析...">
                            <button type="button" id="aiAnalyzeBtn" onclick="analyzeImageWithAI()" class="absolute right-2 top-2 px-2 py-1 bg-purple-500 text-white text-xs rounded hover:bg-purple-600 transition-colors">
                                <i class="fas fa-magic mr-1"></i>AI分析
                            </button>
                        </div>
                    </div>
                </div>

                <!-- AI標籤建議區域 -->
                <div id="aiSuggestions" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-lightbulb mr-1 text-purple-600"></i>
                        AI建議標籤 (點擊添加)
                    </label>
                    <div id="suggestedTags" class="flex flex-wrap gap-2 p-3 bg-purple-50 rounded-lg border border-purple-200">
                        <!-- AI建議的標籤將在這裡顯示 -->
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeUploadModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-times mr-2"></i>
                        取消
                    </button>
                    <button type="submit" id="uploadBtn" class="flex-1 px-4 py-2 bg-gradient-to-r from-gray-700 to-gray-900 text-white rounded-lg hover:from-gray-800 hover:to-black transition-colors">
                        <i class="fab fa-github mr-2"></i>
                        上傳到GitHub
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 編輯模態窗口 -->
    <div id="editModal" class="modal">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fas fa-edit mr-2 text-blue-500"></i>
                    編輯作品
                </h3>
                <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <form id="editForm" class="space-y-6">
                <input type="hidden" id="editWorkId">
                
                <!-- 當前圖片預覽 -->
                <div class="text-center mb-4">
                    <img id="editImagePreview" class="w-32 h-32 object-cover rounded-lg border mx-auto mb-2 shadow-sm">
                    <p class="text-sm text-gray-500">當前圖片</p>
                </div>
                
                <!-- 可選：更換圖片 -->
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-4 text-center hover:border-amber-400 transition-colors">
                    <i class="fas fa-image text-2xl text-gray-400 mb-2"></i>
                    <p class="text-sm text-gray-600 mb-2">如需更換圖片，請選擇新的GIF文件</p>
                    <input type="file" id="editFileInput" accept=".gif" class="text-sm">
                    <p class="text-xs text-gray-500 mt-1">留空則保持原圖片不變</p>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tag mr-1"></i>
                            作品標題 *
                        </label>
                        <input type="text" id="editTitle" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-heading mr-1"></i>
                            副標題
                        </label>
                        <input type="text" id="editSubtitle" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-align-left mr-1"></i>
                        作品描述
                    </label>
                    <textarea id="editDescription" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500"></textarea>
                </div>
                
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-folder mr-1"></i>
                            分類
                        </label>
                        <select id="editCategory" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                            <option value="mantra">咒語系列</option>
                            <option value="buddha">佛號系列</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-tags mr-1"></i>
                            標籤 (用逗號分隔)
                        </label>
                        <input type="text" id="editTags" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500">
                    </div>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="closeEditModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-times mr-2"></i>
                        取消
                    </button>
                    <button type="submit" id="editBtn" class="flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 text-white rounded-lg hover:from-blue-600 hover:to-purple-600 transition-colors">
                        <i class="fas fa-save mr-2"></i>
                        保存修改
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 確認對話框 -->
    <div id="confirmModal" class="modal">
        <div class="modal-content p-8 max-w-md">
            <div class="text-center">
                <div class="text-6xl mb-4" id="confirmIcon">⚠️</div>
                <h3 class="text-xl font-semibold text-gray-800 mb-4" id="confirmTitle">確認操作</h3>
                <p class="text-gray-600 mb-6" id="confirmMessage">您確定要執行此操作嗎？</p>
                <div class="flex gap-4">
                    <button onclick="closeConfirmModal()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        取消
                    </button>
                    <button id="confirmBtn" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">
                        確認
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- GitHub配置模態窗口 -->
    <div id="githubConfigModal" class="modal">
        <div class="modal-content p-8">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-semibold text-gray-800">
                    <i class="fab fa-github mr-2 text-gray-800"></i>
                    GitHub設置
                </h3>
                <button onclick="closeGitHubConfigModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="githubConfigForm" class="space-y-6">
                <!-- Repository設置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fab fa-github mr-1"></i>
                        GitHub Repository
                    </label>
                    <input type="text" id="githubRepo" placeholder="username/repository-name" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500">
                    <p class="text-xs text-gray-500 mt-1">例如: john/my-sticker-gallery</p>
                </div>

                <!-- Access Token設置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-key mr-1"></i>
                        Personal Access Token
                    </label>
                    <input type="password" id="githubToken" placeholder="ghp_xxxxxxxxxxxxxxxxxxxx" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500">
                    <p class="text-xs text-gray-500 mt-1">需要 repo 權限的 GitHub Personal Access Token</p>
                </div>

                <!-- 分支設置 -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-code-branch mr-1"></i>
                        目標分支
                    </label>
                    <input type="text" id="githubBranch" value="main" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-gray-500">
                    <p class="text-xs text-gray-500 mt-1">通常是 main 或 master</p>
                </div>

                <!-- 連接測試 -->
                <div id="connectionTest" class="hidden">
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between mb-2">
                            <span class="text-sm font-medium text-gray-700">連接測試</span>
                            <div id="testStatus" class="text-sm"></div>
                        </div>
                        <div id="testMessage" class="text-xs text-gray-600"></div>
                    </div>
                </div>

                <!-- 設置指南 -->
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-800 mb-2">
                        <i class="fas fa-info-circle mr-1"></i>
                        設置指南
                    </h4>
                    <ol class="text-sm text-blue-700 space-y-1">
                        <li>1. 在GitHub創建一個新的Repository</li>
                        <li>2. 生成Personal Access Token (Settings → Developer settings → Personal access tokens)</li>
                        <li>3. 確保Token有 repo 權限</li>
                        <li>4. 填入上述信息並測試連接</li>
                        <li>5. 連接成功後即可開始上傳貼圖</li>
                    </ol>
                </div>

                <div class="flex gap-4 pt-4">
                    <button type="button" onclick="testGitHubConnection()" class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                        <i class="fas fa-plug mr-2"></i>
                        測試連接
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-gradient-to-r from-gray-700 to-gray-900 text-white rounded-lg hover:from-gray-800 hover:to-black transition-colors">
                        <i class="fas fa-save mr-2"></i>
                        保存設置
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- 隱藏的文件輸入用於匯入 -->
    <input type="file" id="importFileInput" accept=".json" class="hidden">

    <script>
        // 全局變量
        let allWorks = [];
        let filteredWorks = [];
        let selectedWorks = new Set();
        let currentPage = 1;
        let itemsPerPage = 10;
        let viewMode = 'list';
        let batchMode = false;
        let selectedFile = null;
        
        // GitHub相關變量
        let githubConfig = {
            repo: '',
            token: '',
            branch: 'main'
        };
        let isGitHubConnected = false;

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadGitHubConfig();
            loadUploadedWorks();
            setupEventListeners();
            updateStats();
            updateGitHubStatus();
        });

        // 設置事件監聽器
        function setupEventListeners() {
            // 搜索和篩選
            document.getElementById('searchInput').addEventListener('input', debounce(filterWorks, 300));
            document.getElementById('categoryFilter').addEventListener('change', filterWorks);
            document.getElementById('sortBy').addEventListener('change', filterWorks);

            // 文件上傳
            setupFileUpload();

            // 鍵盤快捷鍵
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // 匯入文件
            document.getElementById('importFileInput').addEventListener('change', handleImportFile);
        }

        // 防抖函數
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // 載入已上傳的作品
        function loadUploadedWorks() {
            try {
                allWorks = JSON.parse(localStorage.getItem('uploadedWorks') || '[]');
                filteredWorks = [...allWorks];
                renderWorks();
                updateStats();
            } catch (error) {
                console.error('載入作品失敗:', error);
                showToast('載入作品失敗', 'error');
            }
        }

        // 渲染作品列表
        function renderWorks() {
            const container = document.getElementById('worksContainer');
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const worksToShow = filteredWorks.slice(startIndex, endIndex);

            if (worksToShow.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">📭</div>
                        <h3 class="text-xl font-semibold mb-2">暫無作品</h3>
                        <p class="text-gray-400">
                            ${filteredWorks.length === 0 && allWorks.length > 0 ? '沒有符合條件的作品' : '上傳第一個作品後將在此顯示'}
                        </p>
                    </div>
                `;
                return;
            }

            container.innerHTML = worksToShow.map(work => `
                <div class="work-card border border-gray-200 rounded-lg p-4 hover:shadow-md transition-all ${selectedWorks.has(work.id) ? 'selected' : ''}">
                    <div class="flex items-start gap-4">
                        ${batchMode ? `
                            <div class="flex-shrink-0 pt-2">
                                <input type="checkbox" ${selectedWorks.has(work.id) ? 'checked' : ''} 
                                       onchange="toggleWorkSelection('${work.id}')"
                                       class="w-4 h-4 text-amber-600 border-gray-300 rounded focus:ring-amber-500">
                            </div>
                        ` : ''}
                        <div class="flex-shrink-0">
                            <img src="${work.image}" alt="${work.title}" 
                                 class="w-20 h-20 object-cover rounded-lg border shadow-sm cursor-pointer"
                                 onclick="previewImage('${work.image}', '${work.title}')">
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-semibold text-gray-800 text-lg">${highlightSearchTerm(work.title)}</h4>
                            ${work.subtitle ? `<p class="text-sm text-gray-600 mb-1">${highlightSearchTerm(work.subtitle)}</p>` : ''}
                            ${work.description ? `<p class="text-sm text-gray-500 mb-2">${highlightSearchTerm(work.description)}</p>` : ''}
                            <div class="flex flex-wrap gap-2 mb-2">
                                <span class="px-2 py-1 bg-amber-100 text-amber-700 text-xs rounded-full">
                                    <i class="fas fa-folder mr-1"></i>
                                    ${work.category === 'mantra' ? '咒語系列' : '佛號系列'}
                                </span>
                                <span class="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded-full">
                                    <i class="fas fa-file-image mr-1"></i>
                                    ${work.size}
                                </span>
                                ${work.tags.map(tag => `
                                    <span class="px-2 py-1 bg-blue-100 text-blue-700 text-xs rounded-full">
                                        <i class="fas fa-tag mr-1"></i>
                                        ${highlightSearchTerm(tag)}
                                    </span>
                                `).join('')}
                            </div>
                            <div class="flex items-center justify-between">
                                <p class="text-xs text-gray-400">
                                    <i class="fas fa-clock mr-1"></i>
                                    ${new Date(parseInt(work.id.split('-')[1])).toLocaleString()}
                                </p>
                                <div class="flex items-center space-x-2">
                                    <button onclick="editWork('${work.id}')" 
                                            class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition-colors"
                                            title="編輯作品">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button onclick="downloadWork('${work.id}')" 
                                            class="px-3 py-1 bg-green-500 text-white text-sm rounded hover:bg-green-600 transition-colors"
                                            title="下載作品">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button onclick="confirmDelete('${work.id}')" 
                                            class="px-3 py-1 bg-red-500 text-white text-sm rounded hover:bg-red-600 transition-colors"
                                            title="刪除作品">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');

            updatePagination();
            updateDisplayCount();
        }

        // 高亮搜索詞
        function highlightSearchTerm(text) {
            const searchTerm = document.getElementById('searchInput').value.trim();
            if (!searchTerm) return text;
            
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<span class="search-highlight">$1</span>');
        }

        // 篩選作品
        function filterWorks() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const sortBy = document.getElementById('sortBy').value;

            filteredWorks = allWorks.filter(work => {
                const matchesSearch = !searchTerm || 
                    work.title.toLowerCase().includes(searchTerm) ||
                    work.subtitle?.toLowerCase().includes(searchTerm) ||
                    work.description?.toLowerCase().includes(searchTerm) ||
                    work.tags.some(tag => tag.toLowerCase().includes(searchTerm));

                const matchesCategory = !categoryFilter || work.category === categoryFilter;

                return matchesSearch && matchesCategory;
            });

            // 排序
            filteredWorks.sort((a, b) => {
                switch (sortBy) {
                    case 'newest':
                        return parseInt(b.id.split('-')[1]) - parseInt(a.id.split('-')[1]);
                    case 'oldest':
                        return parseInt(a.id.split('-')[1]) - parseInt(b.id.split('-')[1]);
                    case 'title':
                        return a.title.localeCompare(b.title);
                    case 'size':
                        return parseFloat(b.size) - parseFloat(a.size);
                    default:
                        return 0;
                }
            });

            currentPage = 1;
            renderWorks();
        }

        // 更新統計信息
        function updateStats() {
            document.getElementById('totalCount').textContent = allWorks.length;
        }

        // 更新顯示數量
        function updateDisplayCount() {
            document.getElementById('displayCount').textContent = filteredWorks.length;
        }

        // 更新分頁
        function updatePagination() {
            const totalPages = Math.ceil(filteredWorks.length / itemsPerPage);
            const pagination = document.getElementById('pagination');
            
            if (totalPages <= 1) {
                pagination.classList.add('hidden');
                return;
            }

            pagination.classList.remove('hidden');
            
            // 更新按鈕狀態
            document.getElementById('prevBtn').disabled = currentPage === 1;
            document.getElementById('nextBtn').disabled = currentPage === totalPages;

            // 生成頁碼
            const pageNumbers = document.getElementById('pageNumbers');
            pageNumbers.innerHTML = '';
            
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const btn = document.createElement('button');
                    btn.textContent = i;
                    btn.className = `px-3 py-2 border rounded-lg transition-colors ${
                        i === currentPage 
                            ? 'bg-amber-500 text-white border-amber-500' 
                            : 'border-gray-300 hover:bg-gray-50'
                    }`;
                    btn.onclick = () => changePage(i);
                    pageNumbers.appendChild(btn);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    const span = document.createElement('span');
                    span.textContent = '...';
                    span.className = 'px-2 py-2 text-gray-500';
                    pageNumbers.appendChild(span);
                }
            }
        }

        // 切換頁面
        function changePage(page) {
            if (page === 'prev') {
                currentPage = Math.max(1, currentPage - 1);
            } else if (page === 'next') {
                const totalPages = Math.ceil(filteredWorks.length / itemsPerPage);
                currentPage = Math.min(totalPages, currentPage + 1);
            } else {
                currentPage = page;
            }
            renderWorks();
        }

        // 顯示上傳模態窗口
        function showUploadModal() {
            document.getElementById('uploadModal').classList.add('show');
            resetUploadForm();
        }

        // 關閉上傳模態窗口
        function closeUploadModal() {
            document.getElementById('uploadModal').classList.remove('show');
        }

        // 重置上傳表單
        function resetUploadForm() {
            document.getElementById('uploadForm').reset();
            selectedFile = null;
            resetUploadArea();
        }

        // 重置上傳區域
        function resetUploadArea() {
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="text-6xl text-amber-500 mb-4">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <p class="text-lg text-gray-600 mb-2">點擊選擇GIF文件或拖拽到此處</p>
                <p class="text-sm text-gray-500">支援透明背景的GIF格式，最大10MB</p>
            `;
            uploadArea.classList.remove('border-green-400', 'bg-green-50');
        }

        // 設置文件上傳
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            uploadArea.addEventListener('click', () => fileInput.click());

            fileInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                handleFileSelection(file);
            });

            // 拖拽功能
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const file = e.dataTransfer.files[0];
                handleFileSelection(file);
            });
        }

        // 處理文件選擇
        function handleFileSelection(file) {
            if (!file) return;

            if (file.type !== 'image/gif') {
                showToast('請選擇GIF格式的文件', 'error');
                return;
            }

            if (file.size > 10 * 1024 * 1024) { // 10MB
                showToast('文件大小不能超過10MB', 'error');
                return;
            }

            selectedFile = file;
            const uploadArea = document.getElementById('uploadArea');
            uploadArea.innerHTML = `
                <div class="text-6xl text-green-500 mb-4">
                    <i class="fas fa-check-circle"></i>
                </div>
                <p class="text-lg text-green-600 mb-2">已選擇文件：${file.name}</p>
                <p class="text-sm text-gray-500">大小：${(file.size / 1024).toFixed(1)} KB</p>
            `;
            uploadArea.classList.add('border-green-400', 'bg-green-50');
        }

        // 上傳表單提交
        document.getElementById('uploadForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (!selectedFile) {
                showToast('請先選擇要上傳的GIF文件', 'error');
                return;
            }

            const title = document.getElementById('title').value.trim();
            if (!title) {
                showToast('請填寫作品標題', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<div class="loading mr-2"></div>上傳中...';
            uploadBtn.disabled = true;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const workData = {
                        id: 'upload-' + Date.now(),
                        title: title,
                        subtitle: document.getElementById('subtitle').value.trim(),
                        description: document.getElementById('description').value.trim(),
                        category: document.getElementById('category').value,
                        tags: document.getElementById('tags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                        size: `${(selectedFile.size / 1024).toFixed(1)} KB`,
                        image: e.target.result,
                        features: ['透明背景', '高品質', '社群媒體優化'],
                        special: false,
                        createdAt: Date.now()
                    };

                    allWorks.push(workData);
                    localStorage.setItem('uploadedWorks', JSON.stringify(allWorks));

                    showToast('作品上傳成功！', 'success');
                    closeUploadModal();
                    loadUploadedWorks();
                } catch (error) {
                    console.error('上傳失敗:', error);
                    showToast('上傳失敗，請重試', 'error');
                } finally {
                    uploadBtn.innerHTML = originalText;
                    uploadBtn.disabled = false;
                }
            };
            
            reader.onerror = function() {
                showToast('文件讀取失敗，請重試', 'error');
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            };
            
            reader.readAsDataURL(selectedFile);
        });

        // 編輯作品
        function editWork(workId) {
            const work = allWorks.find(w => w.id === workId);
            if (!work) {
                showToast('找不到要編輯的作品', 'error');
                return;
            }

            // 填充編輯表單
            document.getElementById('editWorkId').value = work.id;
            document.getElementById('editTitle').value = work.title;
            document.getElementById('editSubtitle').value = work.subtitle || '';
            document.getElementById('editDescription').value = work.description || '';
            document.getElementById('editCategory').value = work.category;
            document.getElementById('editTags').value = work.tags.join(', ');
            document.getElementById('editImagePreview').src = work.image;
            document.getElementById('editFileInput').value = '';
            
            document.getElementById('editModal').classList.add('show');
        }

        // 關閉編輯模態窗口
        function closeEditModal() {
            document.getElementById('editModal').classList.remove('show');
        }

        // 編輯表單提交
        document.getElementById('editForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const workId = document.getElementById('editWorkId').value;
            const title = document.getElementById('editTitle').value.trim();
            
            if (!title) {
                showToast('請填寫作品標題', 'error');
                return;
            }

            const editBtn = document.getElementById('editBtn');
            const originalText = editBtn.innerHTML;
            editBtn.innerHTML = '<div class="loading mr-2"></div>保存中...';
            editBtn.disabled = true;

            try {
                const workIndex = allWorks.findIndex(w => w.id === workId);
                if (workIndex === -1) {
                    showToast('找不到要編輯的作品', 'error');
                    return;
                }

                const updatedWork = {
                    ...allWorks[workIndex],
                    title: title,
                    subtitle: document.getElementById('editSubtitle').value.trim(),
                    description: document.getElementById('editDescription').value.trim(),
                    category: document.getElementById('editCategory').value,
                    tags: document.getElementById('editTags').value.split(',').map(tag => tag.trim()).filter(tag => tag),
                    updatedAt: Date.now()
                };

                const newFile = document.getElementById('editFileInput').files[0];
                if (newFile && newFile.type === 'image/gif') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        updatedWork.image = e.target.result;
                        updatedWork.size = `${(newFile.size / 1024).toFixed(1)} KB`;
                        
                        allWorks[workIndex] = updatedWork;
                        localStorage.setItem('uploadedWorks', JSON.stringify(allWorks));
                        
                        showToast('作品編輯成功！', 'success');
                        closeEditModal();
                        loadUploadedWorks();
                        
                        editBtn.innerHTML = originalText;
                        editBtn.disabled = false;
                    };
                    reader.readAsDataURL(newFile);
                } else {
                    allWorks[workIndex] = updatedWork;
                    localStorage.setItem('uploadedWorks', JSON.stringify(allWorks));
                    
                    showToast('作品編輯成功！', 'success');
                    closeEditModal();
                    loadUploadedWorks();
                    
                    editBtn.innerHTML = originalText;
                    editBtn.disabled = false;
                }
            } catch (error) {
                console.error('保存編輯失敗:', error);
                showToast('保存失敗，請重試', 'error');
                editBtn.innerHTML = originalText;
                editBtn.disabled = false;
            }
        });

        // 下載作品
        function downloadWork(workId) {
            const work = allWorks.find(w => w.id === workId);
            if (!work) {
                showToast('找不到要下載的作品', 'error');
                return;
            }

            try {
                const link = document.createElement('a');
                link.href = work.image;
                link.download = `${work.title}.gif`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('下載開始', 'success');
            } catch (error) {
                console.error('下載失敗:', error);
                showToast('下載失敗，請重試', 'error');
            }
        }

        // 確認刪除
        function confirmDelete(workId) {
            const work = allWorks.find(w => w.id === workId);
            if (!work) return;

            showConfirmModal(
                '🗑️',
                '確認刪除',
                `您確定要刪除作品「${work.title}」嗎？此操作無法撤銷。`,
                () => deleteWork(workId)
            );
        }

        // 刪除作品
        function deleteWork(workId) {
            try {
                allWorks = allWorks.filter(w => w.id !== workId);
                localStorage.setItem('uploadedWorks', JSON.stringify(allWorks));
                selectedWorks.delete(workId);
                
                showToast('作品已成功刪除', 'success');
                loadUploadedWorks();
            } catch (error) {
                console.error('刪除失敗:', error);
                showToast('刪除失敗，請重試', 'error');
            }
        }

        // 顯示確認模態窗口
        function showConfirmModal(icon, title, message, onConfirm) {
            document.getElementById('confirmIcon').textContent = icon;
            document.getElementById('confirmTitle').textContent = title;
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmBtn').onclick = () => {
                onConfirm();
                closeConfirmModal();
            };
            document.getElementById('confirmModal').classList.add('show');
        }

        // 關閉確認模態窗口
        function closeConfirmModal() {
            document.getElementById('confirmModal').classList.remove('show');
        }

        // 切換批量模式
        function toggleBatchMode() {
            batchMode = !batchMode;
            const btn = document.getElementById('batchModeBtn');
            const actions = document.getElementById('batchActions');
            
            if (batchMode) {
                btn.innerHTML = '<i class="fas fa-times mr-2"></i>退出批量';
                btn.classList.add('bg-red-100', 'text-red-700', 'border-red-300');
                actions.classList.remove('hidden');
            } else {
                btn.innerHTML = '<i class="fas fa-check-square mr-2"></i>批量操作';
                btn.classList.remove('bg-red-100', 'text-red-700', 'border-red-300');
                actions.classList.add('hidden');
                selectedWorks.clear();
            }
            
            renderWorks();
        }

        // 切換作品選擇
        function toggleWorkSelection(workId) {
            if (selectedWorks.has(workId)) {
                selectedWorks.delete(workId);
            } else {
                selectedWorks.add(workId);
            }
            renderWorks();
        }

        // 批量下載
        function batchDownload() {
            if (selectedWorks.size === 0) {
                showToast('請先選擇要下載的作品', 'warning');
                return;
            }

            selectedWorks.forEach(workId => {
                setTimeout(() => downloadWork(workId), 100);
            });
        }

        // 批量刪除
        function batchDelete() {
            if (selectedWorks.size === 0) {
                showToast('請先選擇要刪除的作品', 'warning');
                return;
            }

            showConfirmModal(
                '🗑️',
                '批量刪除',
                `您確定要刪除選中的 ${selectedWorks.size} 個作品嗎？此操作無法撤銷。`,
                () => {
                    selectedWorks.forEach(workId => {
                        allWorks = allWorks.filter(w => w.id !== workId);
                    });
                    localStorage.setItem('uploadedWorks', JSON.stringify(allWorks));
                    selectedWorks.clear();
                    showToast('批量刪除成功', 'success');
                    loadUploadedWorks();
                }
            );
        }

        // 匯出數據
        function exportData() {
            try {
                const dataStr = JSON.stringify(allWorks, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `宗教貼圖館_備份_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                showToast('數據匯出成功', 'success');
            } catch (error) {
                console.error('匯出失敗:', error);
                showToast('匯出失敗，請重試', 'error');
            }
        }

        // 匯入數據
        function importData() {
            document.getElementById('importFileInput').click();
        }

        // 處理匯入文件
        function handleImportFile(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (!Array.isArray(importedData)) {
                        throw new Error('無效的數據格式');
                    }

                    showConfirmModal(
                        '📥',
                        '確認匯入',
                        `即將匯入 ${importedData.length} 個作品，這將覆蓋現有數據。確定要繼續嗎？`,
                        () => {
                            allWorks = importedData;
                            localStorage.setItem('uploadedWorks', JSON.stringify(allWorks));
                            loadUploadedWorks();
                            showToast('數據匯入成功', 'success');
                        }
                    );
                } catch (error) {
                    console.error('匯入失敗:', error);
                    showToast('匯入失敗，請檢查文件格式', 'error');
                }
            };
            reader.readAsText(file);
        }

        // 切換視圖模式
        function changeView(mode) {
            viewMode = mode;
            document.getElementById('gridViewBtn').classList.toggle('text-amber-600', mode === 'grid');
            document.getElementById('listViewBtn').classList.toggle('text-amber-600', mode === 'list');
            // 這裡可以實現網格視圖的邏輯
        }

        // 預覽圖片
        function previewImage(src, title) {
            // 可以實現圖片預覽功能
            window.open(src, '_blank');
        }

        // 鍵盤快捷鍵
        function handleKeyboardShortcuts(e) {
            if (e.ctrlKey || e.metaKey) {
                switch (e.key) {
                    case 'n':
                        e.preventDefault();
                        showUploadModal();
                        break;
                    case 'f':
                        e.preventDefault();
                        document.getElementById('searchInput').focus();
                        break;
                    case 's':
                        e.preventDefault();
                        exportData();
                        break;
                }
            }
            
            if (e.key === 'Escape') {
                closeUploadModal();
                closeEditModal();
                closeConfirmModal();
            }
        }

        // 顯示提示消息
        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'exclamation-triangle'} mr-2"></i>
                ${message}
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => toast.classList.add('show'), 100);
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => document.body.removeChild(toast), 300);
            }, 3000);
        }

        // 點擊模態窗口外部關閉
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('show');
            }
        });

        // ==================== GitHub 整合功能 ====================

        // 載入GitHub配置
        function loadGitHubConfig() {
            const saved = localStorage.getItem('githubConfig');
            if (saved) {
                githubConfig = JSON.parse(saved);
                document.getElementById('githubRepo').value = githubConfig.repo || '';
                document.getElementById('githubToken').value = githubConfig.token || '';
                document.getElementById('githubBranch').value = githubConfig.branch || 'main';
                
                if (githubConfig.repo && githubConfig.token) {
                    isGitHubConnected = true;
                }
            }
        }

        // 保存GitHub配置
        function saveGitHubConfig() {
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
            updateGitHubStatus();
        }

        // 更新GitHub連接狀態
        function updateGitHubStatus() {
            const statusElement = document.getElementById('githubStatus');
            const connectionStatusElement = document.getElementById('connectionStatus');
            
            if (isGitHubConnected) {
                statusElement.className = 'github-status github-connected';
                statusElement.innerHTML = '<i class="fab fa-github mr-1"></i>已連接';
                
                if (connectionStatusElement) {
                    connectionStatusElement.className = 'github-status github-connected';
                    connectionStatusElement.innerHTML = '<i class="fas fa-check-circle mr-1"></i>已連接';
                }
                
                const messageElement = document.getElementById('connectionMessage');
                if (messageElement) {
                    messageElement.textContent = `已連接到 ${githubConfig.repo}`;
                }
            } else {
                statusElement.className = 'github-status github-disconnected';
                statusElement.innerHTML = '<i class="fab fa-github mr-1"></i>未連接';
                
                if (connectionStatusElement) {
                    connectionStatusElement.className = 'github-status github-disconnected';
                    connectionStatusElement.innerHTML = '<i class="fas fa-times-circle mr-1"></i>未連接';
                }
            }
        }

        // 顯示GitHub配置模態窗口
        function showGitHubConfigModal() {
            document.getElementById('githubConfigModal').classList.add('show');
        }

        // 關閉GitHub配置模態窗口
        function closeGitHubConfigModal() {
            document.getElementById('githubConfigModal').classList.remove('show');
        }

        // 測試GitHub連接
        async function testGitHubConnection() {
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();
            const branch = document.getElementById('githubBranch').value.trim() || 'main';

            if (!repo || !token) {
                showToast('請填入Repository和Access Token', 'error');
                return;
            }

            const testElement = document.getElementById('connectionTest');
            const statusElement = document.getElementById('testStatus');
            const messageElement = document.getElementById('testMessage');

            testElement.classList.remove('hidden');
            statusElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>測試中...';
            statusElement.className = 'text-sm text-blue-600';
            messageElement.textContent = '正在驗證GitHub連接...';

            try {
                // 測試GitHub API連接
                const response = await fetch(`https://api.github.com/repos/${repo}`, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });

                if (response.ok) {
                    const repoData = await response.json();
                    statusElement.innerHTML = '<i class="fas fa-check-circle mr-1"></i>連接成功';
                    statusElement.className = 'text-sm text-green-600';
                    messageElement.textContent = `成功連接到 ${repoData.full_name}`;
                    
                    // 更新配置
                    githubConfig = { repo, token, branch };
                    isGitHubConnected = true;
                    
                    showToast('GitHub連接測試成功！', 'success');
                } else {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
            } catch (error) {
                statusElement.innerHTML = '<i class="fas fa-times-circle mr-1"></i>連接失敗';
                statusElement.className = 'text-sm text-red-600';
                messageElement.textContent = `錯誤: ${error.message}`;
                
                showToast('GitHub連接測試失敗', 'error');
            }
        }

        // GitHub配置表單提交
        document.getElementById('githubConfigForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const repo = document.getElementById('githubRepo').value.trim();
            const token = document.getElementById('githubToken').value.trim();
            const branch = document.getElementById('githubBranch').value.trim() || 'main';

            if (!repo || !token) {
                showToast('請填入所有必要信息', 'error');
                return;
            }

            githubConfig = { repo, token, branch };
            isGitHubConnected = true;
            
            saveGitHubConfig();
            closeGitHubConfigModal();
            
            showToast('GitHub設置已保存', 'success');
        });

        // 上傳文件到GitHub
        async function uploadToGitHub(fileName, content, commitMessage) {
            if (!isGitHubConnected) {
                throw new Error('GitHub未連接，請先配置GitHub設置');
            }

            const { repo, token, branch } = githubConfig;
            const path = `images/${fileName}`;

            try {
                // 檢查文件是否已存在
                let sha = null;
                try {
                    const existingResponse = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                        headers: {
                            'Authorization': `token ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    });
                    
                    if (existingResponse.ok) {
                        const existingData = await existingResponse.json();
                        sha = existingData.sha;
                    }
                } catch (e) {
                    // 文件不存在，繼續上傳
                }

                // 上傳文件
                const uploadData = {
                    message: commitMessage,
                    content: content,
                    branch: branch
                };

                if (sha) {
                    uploadData.sha = sha;
                }

                const response = await fetch(`https://api.github.com/repos/${repo}/contents/${path}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(uploadData)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || `HTTP ${response.status}`);
                }

                const result = await response.json();
                return result.content.download_url;
            } catch (error) {
                console.error('GitHub上傳錯誤:', error);
                throw error;
            }
        }

        // 上傳作品數據到GitHub
        async function uploadWorksDataToGitHub() {
            if (!isGitHubConnected) {
                return;
            }

            try {
                const worksData = {
                    works: allWorks,
                    lastUpdated: new Date().toISOString()
                };

                const content = btoa(unescape(encodeURIComponent(JSON.stringify(worksData, null, 2))));
                
                await uploadToGitHub('works.json', content, 'Update works data');
                
                showToast('作品數據已同步到GitHub', 'success');
            } catch (error) {
                console.error('同步作品數據失敗:', error);
                showToast('同步作品數據失敗: ' + error.message, 'error');
            }
        }

        // 修改原有的上傳函數以支援GitHub
        const originalUploadForm = document.getElementById('uploadForm');
        originalUploadForm.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!isGitHubConnected) {
                showToast('請先配置GitHub設置', 'error');
                showGitHubConfigModal();
                return;
            }

            if (!selectedFile) {
                showToast('請選擇要上傳的文件', 'error');
                return;
            }

            const title = document.getElementById('title').value.trim();
            const subtitle = document.getElementById('subtitle').value.trim();
            const description = document.getElementById('description').value.trim();
            const category = document.getElementById('category').value;
            const tags = document.getElementById('tags').value.trim();

            if (!title) {
                showToast('請填入作品標題', 'error');
                return;
            }

            const uploadBtn = document.getElementById('uploadBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>上傳中...';
            uploadBtn.disabled = true;

            try {
                // 轉換文件為base64
                const reader = new FileReader();
                reader.onload = async function(e) {
                    try {
                        const base64Content = e.target.result.split(',')[1];
                        const fileName = `${Date.now()}_${selectedFile.name}`;
                        
                        // 上傳到GitHub
                        const githubUrl = await uploadToGitHub(
                            fileName, 
                            base64Content, 
                            `Add new sticker: ${title}`
                        );

                        // 創建作品對象
                        const work = {
                            id: Date.now(),
                            title,
                            subtitle,
                            description,
                            category,
                            tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                            gifUrl: githubUrl,
                            webpUrl: null, // 可以後續添加WebP轉換
                            fileSize: selectedFile.size,
                            uploadDate: new Date().toISOString(),
                            source: 'github'
                        };

                        // 添加到本地存儲
                        allWorks.unshift(work);
                        localStorage.setItem('uploadedWorks', JSON.stringify(allWorks));

                        // 同步作品數據到GitHub
                        await uploadWorksDataToGitHub();

                        // 更新界面
                        applyFilters();
                        updateStats();
                        closeUploadModal();
                        
                        showToast('作品已成功上傳到GitHub！', 'success');
                        
                        // 重置表單
                        document.getElementById('uploadForm').reset();
                        selectedFile = null;
                        document.getElementById('formatPreview').classList.add('hidden');
                        
                    } catch (error) {
                        console.error('上傳失敗:', error);
                        showToast('上傳失敗: ' + error.message, 'error');
                    } finally {
                        uploadBtn.innerHTML = originalText;
                        uploadBtn.disabled = false;
                    }
                };
                
                reader.readAsDataURL(selectedFile);
                
            } catch (error) {
                console.error('上傳失敗:', error);
                showToast('上傳失敗: ' + error.message, 'error');
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            }
        });
    </script>
</body>
</html>

